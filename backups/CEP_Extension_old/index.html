<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expression Control</title>

    <!-- „Ç∑„É≥„Éó„É´„Å™„Ç®„Éá„Ç£„Çø„ÉºÔºàÂ§ñÈÉ®‰æùÂ≠ò„Å™„ÅóÔºâ -->

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #2a2a2a;
            color: #ffffff;
            margin: 0;
            padding: 15px;
            font-size: 13px;
        }

        .container {
            max-width: 100%;
            padding-bottom: 30px;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
        }

        .header h1 {
            margin: 0;
            font-size: 18px;
            color: #FFE082;
        }

        .section {
            margin-bottom: 15px;
            position: relative;
            z-index: 10;
        }

        .section label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #BDBDBD;
            font-size: 12px;
        }

        .main-button {
            width: 100%;
            padding: 12px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .main-button:hover {
            background: #45a049;
        }

        /* „Çª„ÇØ„Ç∑„Éß„É≥Èñì„ÅÆ„Çπ„Éö„Éº„Çπ„ÇíÁ¢∫‰øù */
        .section:focus-within {
            z-index: 99998;
        }

        .section.dropdown-open {
            z-index: 99998;
        }

        /* „Ç´„Çπ„Çø„É†„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„ÅÆ„Çπ„Çø„Ç§„É´ */
        .custom-dropdown {
            position: relative;
            width: 100%;
        }

        .dropdown-button {
            width: 100%;
            padding: 8px 12px;
            background: #3a3a3a;
            color: white;
            border: 1px solid #555;
            border-radius: 3px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-sizing: border-box;
        }

        .dropdown-button:hover {
            background: #4a4a4a;
            border-color: #4CAF50;
        }

        .dropdown-arrow {
            font-size: 10px;
            transition: transform 0.2s;
        }

        .dropdown-button.open .dropdown-arrow {
            transform: rotate(180deg);
        }

        .dropdown-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #2a2a2a;
            border: 1px solid #555;
            border-top: none;
            border-radius: 0 0 3px 3px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 99999;
            display: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .dropdown-list.show {
            display: block;
        }

        .dropdown-item {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 12px;
            border-bottom: 1px solid #3a3a3a;
        }

        .dropdown-item:hover {
            background: #4a4a4a;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item.selected {
            background: #4CAF50;
            color: white;
        }

        /* CodeMirror Editor container */
        #editorContainer {
            width: 100%;
            min-height: 150px;
            border: 1px solid #555;
            border-radius: 3px;
            background: #1a1a1a;
            position: relative;
            box-sizing: border-box;
        }

        .apply-button {
            width: 100%;
            padding: 12px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
        }

        .apply-button:hover {
            background: #1976D2;
        }

        .apply-button:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .info-text {
            padding: 8px;
            background: #333;
            border-radius: 3px;
            color: #BDBDBD;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .messages {
            margin-top: 15px;
        }

        .success-message {
            background: rgba(76, 175, 80, 0.3);
            border: 1px solid #4CAF50;
            color: #C8E6C9;
            padding: 10px;
            border-radius: 3px;
            display: none;
            font-size: 12px;
        }

        .error-message {
            background: rgba(244, 67, 54, 0.3);
            border: 1px solid #F44336;
            color: #FFCDD2;
            padding: 10px;
            border-radius: 3px;
            display: none;
            font-size: 12px;
        }

        .status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #1a1a1a;
            padding: 5px 15px;
            border-top: 1px solid #444;
            font-size: 11px;
            color: #888;
            z-index: 100;
        }

        /* „Ç∑„É≥„Çø„ÉÉ„ÇØ„Çπ„Éè„Ç§„É©„Ç§„Éà„Ç®„Éá„Ç£„Çø„Éº */
        .syntax-editor-container {
            position: relative;
            width: 100%;
            min-height: 200px;
            border: 1px solid #555;
            border-radius: 4px;
            background: #1e1e1e;
            overflow: hidden;
        }

        .highlight-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 12px;
            background: transparent;
            color: transparent;
            font-family: 'Courier New', 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            line-height: 1.4;
            white-space: pre-wrap;
            word-wrap: break-word;
            pointer-events: none;
            z-index: 1;
            box-sizing: border-box;
            overflow: hidden;
        }

        .editor-textarea {
            position: relative;
            width: 100%;
            min-height: 200px;
            padding: 12px;
            background: transparent;
            color: #cccccc;
            border: none;
            outline: none;
            font-family: 'Courier New', 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            line-height: 1.4;
            white-space: pre-wrap;
            word-wrap: break-word;
            resize: vertical;
            z-index: 2;
            box-sizing: border-box;
        }

        .editor-textarea::selection {
            background: rgba(77, 166, 255, 0.3);
        }

        /* „Ç∑„É≥„Çø„ÉÉ„ÇØ„Çπ„Éè„Ç§„É©„Ç§„ÉàËâ≤ */
        .token-ae-keyword {
            color: #4FC3F7;
            font-weight: bold;
        }

        .token-js-keyword {
            color: #BA68C8;
            font-weight: bold;
        }

        .token-string {
            color: #FFB74D;
        }

        .token-number {
            color: #81C784;
        }

        .token-comment {
            color: #757575;
            font-style: italic;
        }

        .token-bracket {
            color: #64B5F6;
            font-weight: bold;
        }

        .token-operator {
            color: #E0E0E0;
        }

        .token-function {
            color: #FFEB3B;
        }

        /* CodeMirror 6 „Ç´„Çπ„Çø„É†„Çπ„Çø„Ç§„É´ */
        .code-editor .cm-editor {
            height: 100% !important;
            border: 1px solid #555 !important;
            border-radius: 4px !important;
            background: #1e1e1e !important;
            color: #d4d4d4 !important;
        }

        .code-editor .cm-content {
            padding: 12px !important;
            min-height: 200px !important;
            font-family: 'Courier New', 'Monaco', 'Menlo', monospace !important;
            font-size: 13px !important;
            line-height: 1.4 !important;
            color: #d4d4d4 !important;
            background: #1e1e1e !important;
        }

        .code-editor .cm-focused {
            outline: none !important;
            border-color: #4da6ff !important;
        }

        .code-editor .cm-scroller {
            font-family: 'Courier New', 'Monaco', 'Menlo', monospace !important;
        }

        /* „Ç™„Éº„Éà„Ç≥„É≥„Éó„É™„Éº„Éà„ÅÆ„Çπ„Çø„Ç§„É´ */
        .code-editor .cm-tooltip-autocomplete {
            background-color: #2a2a2a !important;
            border: 1px solid #555 !important;
            border-radius: 4px !important;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3) !important;
            z-index: 1000 !important;
        }

        .code-editor .cm-tooltip-autocomplete ul li {
            padding: 6px 10px !important;
            color: #cccccc !important;
            font-size: 12px !important;
        }

        .code-editor .cm-tooltip-autocomplete ul li[aria-selected] {
            background-color: #4da6ff !important;
            color: #ffffff !important;
        }

        /* „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„Ç®„Éá„Ç£„Çø„ÉºÁî®„Çπ„Çø„Ç§„É´ */
        #fallbackEditor {
            width: 100%;
            height: 200px;
            padding: 12px;
            background: #1e1e1e;
            color: #cccccc;
            border: 1px solid #555;
            border-radius: 4px;
            font-family: 'Courier New', 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            line-height: 1.4;
            resize: vertical;
            box-sizing: border-box;
        }

        #fallbackEditor:focus {
            outline: none;
            border-color: #4da6ff;
        }

        .editor-container {
            width: 100%;
            min-height: 200px;
            border-radius: 4px;
            background: #1e1e1e;
            position: relative;
            box-sizing: border-box;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>Expression Control</h1>
        </div>

        <!-- This Layer(s) „Éú„Çø„É≥ -->
        <div class="section">
            <button id="thisLayersBtn" onclick="refreshLayers()" class="main-button">This Layer(s)</button>
            <div id="layerInfo" class="info-text">„É¨„Ç§„É§„Éº„ÇíÈÅ∏Êäû„Åó„Å¶„Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ</div>
        </div>

        <!-- „Ç®„ÇØ„Çπ„Éó„É¨„ÉÉ„Ç∑„Éß„É≥ÂèØËÉΩ„Éó„É≠„Éë„ÉÜ„Ç£‰∏ÄË¶ß -->
        <div class="section">
            <label>„Ç®„ÇØ„Çπ„Éó„É¨„ÉÉ„Ç∑„Éß„É≥ÂèØËÉΩ„Éó„É≠„Éë„ÉÜ„Ç£:</label>
            <div class="custom-dropdown" id="allPropsCustomDropdown">
                <div class="dropdown-button" onclick="toggleDropdown('allProps')">
                    <span id="allPropsSelected">„Éó„É≠„Éë„ÉÜ„Ç£„ÇíÈÅ∏Êäû...</span>
                    <span class="dropdown-arrow">‚ñº</span>
                </div>
                <div class="dropdown-list" id="allPropsList">
                    <!-- „Éó„É≠„Éë„ÉÜ„Ç£„Åå„Åì„Åì„Å´ÂãïÁöÑ„Å´ËøΩÂä†„Åï„Çå„Çã -->
                </div>
            </div>
        </div>

        <!-- Êó¢Â≠ò„Ç®„ÇØ„Çπ„Éó„É¨„ÉÉ„Ç∑„Éß„É≥‰∏ÄË¶ß -->
        <div class="section">
            <label>Êó¢Â≠ò„Ç®„ÇØ„Çπ„Éó„É¨„ÉÉ„Ç∑„Éß„É≥:</label>
            <div class="custom-dropdown" id="existingExprsCustomDropdown">
                <div class="dropdown-button" onclick="toggleDropdown('existingExprs')">
                    <span id="existingExprsSelected">-----</span>
                    <span class="dropdown-arrow">‚ñº</span>
                </div>
                <div class="dropdown-list" id="existingExprsList">
                    <!-- Êó¢Â≠ò„Ç®„ÇØ„Çπ„Éó„É¨„ÉÉ„Ç∑„Éß„É≥„Åå„Åì„Åì„Å´ÂãïÁöÑ„Å´ËøΩÂä†„Åï„Çå„Çã -->
                </div>
            </div>
        </div>

        <!-- „Ç®„ÇØ„Çπ„Éó„É¨„ÉÉ„Ç∑„Éß„É≥Ë®òÂÖ•Ê¨Ñ -->
        <div class="section">
            <label>„Ç®„ÇØ„Çπ„Éó„É¨„ÉÉ„Ç∑„Éß„É≥:</label>
            <div class="syntax-editor-container">
                <!-- „Éè„Ç§„É©„Ç§„ÉàË°®Á§∫„É¨„Ç§„É§„Éº -->
                <div id="highlightLayer" class="highlight-layer"></div>
                <!-- ÂÖ•ÂäõÁî®textarea -->
                <textarea id="expressionEditor" class="editor-textarea" placeholder="„Ç®„ÇØ„Çπ„Éó„É¨„ÉÉ„Ç∑„Éß„É≥„ÇíÂÖ•Âäõ..."></textarea>
            </div>
        </div>

        <!-- Apply „Éú„Çø„É≥ -->
        <div class="section">
            <button id="applyBtn" onclick="applyExpression()" class="apply-button">Apply</button>
        </div>

        <!-- „É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫ -->
        <div class="messages">
            <div class="success-message" id="successMessage"></div>
            <div class="error-message" id="errorMessage"></div>
        </div>
    </div>

    <div class="status-bar">
        <span id="statusText">Expression Control - Ready</span>
    </div>

    <!-- CEP Communication Library -->
    <script src="js/CSInterface.js"></script>

    <script>
        // CEP Interface
        var csInterface;
        var selectedLayers = [];
        var allProperties = [];
        var currentProperty = null;

        // CodeMirror EditorÂ§âÊï∞
        let codeMirrorEditor = null;

        // After Effects Expression Keywords
        const AE_EXPRESSION_KEYWORDS = [
            'thisComp', 'thisLayer', 'time', 'value', 'wiggle', 'ease', 'linear',
            'key', 'marker', 'effect', 'transform', 'position', 'scale', 'rotation',
            'opacity', 'anchorPoint', 'width', 'height', 'index', 'name', 'parent',
            'source', 'inPoint', 'outPoint', 'startTime', 'duration', 'frameDuration',
            'comp', 'layer', 'property', 'propertyGroup', 'numKeys', 'keyTime',
            'keyValue', 'velocityAtTime', 'speedAtTime', 'temporalEase', 'spatialTangent',
            'isSpatial', 'canSetExpression', 'expression', 'expressionEnabled',
            'valueAtTime', 'nearestKeyIndex', 'keyIndex', 'numProperties', 'propertyIndex',
            'propertyName', 'matchName', 'isEffect', 'isLayer', 'active', 'enabled',
            'hasParent', 'stretch', 'timeRemap', 'blendingMode', 'trackMatteType',
            'hasTrackMatte', 'isTrackMatte', 'preserveTransparency', 'quality',
            'motionBlur', 'frameBlending', 'threeDLayer', 'environmentLayer',
            'collapseTransformation', 'frameRate', 'pixelAspect', 'shutterAngle',
            'shutterPhase', 'workAreaStart', 'workAreaDuration', 'numLayers',
            'activeCamera', 'displayStartTime', 'footageMissing', 'bgColor',
            'cameraOption', 'lightOption'
        ];

        // CodeMirror EditorÂàùÊúüÂåñ
        function initializeSyntaxEditor() {
            try {
                console.log('Initializing CodeMirror Editor...');

                // CodeMirror„Åå„É≠„Éº„Éâ„Åï„Çå„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                if (typeof CodeMirror === 'undefined') {
                    throw new Error('CodeMirror not loaded');
                }

                // „Ç®„Éá„Ç£„Çø„ÉºË®≠ÂÆöÔºàÊ≠£„Åó„ÅÑAPIÔºâ
                const { EditorView, basicSetup } = CM["@codemirror/view"];
                const { javascript } = CM["@codemirror/lang-javascript"];
                const { oneDark } = CM["@codemirror/theme-one-dark"];
                const { autocompletion } = CM["@codemirror/autocomplete"];

                const extensions = [
                    basicSetup,
                    javascript(),
                    oneDark,
                    CodeMirror.EditorView.updateListener.of((update) => {
                        if (update.docChanged) {
                            // Èö†„Åótextarea„Å®ÂêåÊúü
                            document.getElementById('expressionEditor').value = codeMirrorEditor.state.doc.toString();
                        }
                    }),
                    CodeMirror.EditorView.theme({
                        '&': {
                            height: '150px',
                            fontSize: '13px'
                        },
                        '.cm-content': {
                            padding: '10px',
                            minHeight: '150px'
                        },
                        '.cm-editor': {
                            borderRadius: '3px'
                        },
                        '.cm-scroller': {
                            fontFamily: 'Courier New, Monaco, Menlo, monospace'
                        }
                    })
                ];

                // „Ç®„Éá„Ç£„Çø„Éº‰ΩúÊàê
                codeMirrorEditor = new CodeMirror.EditorView({
                    doc: '// „Ç®„ÇØ„Çπ„Éó„É¨„ÉÉ„Ç∑„Éß„É≥„Çí„Åì„Åì„Å´ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ\n',
                    extensions: extensions,
                    parent: document.getElementById('codeMirrorEditor')
                });

                console.log('CodeMirror Editor initialized successfully');
                document.getElementById('statusText').textContent = 'Expression Control - CodeMirror Ready ‚ú®';
                updateStatusBar();
                return true;

            } catch (error) {
                console.error('CodeMirror initialization failed:', error);
                showFallbackTextarea();
                return false;
            }
        }

        // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: ÈÄöÂ∏∏„ÅÆtextarea„ÇíË°®Á§∫
        function showFallbackTextarea() {
            console.log('Using fallback textarea editor');

            const container = document.getElementById('codeMirrorEditor');
            container.style.display = 'none';

            const textarea = document.getElementById('fallbackEditor');
            textarea.style.display = 'block';
            textarea.placeholder = '„Ç®„ÇØ„Çπ„Éó„É¨„ÉÉ„Ç∑„Éß„É≥„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ (Fallback Editor)';
            textarea.value = '// „Ç®„ÇØ„Çπ„Éó„É¨„ÉÉ„Ç∑„Éß„É≥„Çí„Åì„Åì„Å´ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ\n';

            // Âü∫Êú¨ÁöÑ„Å™„Çø„ÉñÊ©üËÉΩ„ÇíËøΩÂä†
            textarea.addEventListener('keydown', function (e) {
                if (e.key === 'Tab') {
                    e.preventDefault();
                    const start = this.selectionStart;
                    const end = this.selectionEnd;
                    this.value = this.value.substring(0, start) + '  ' + this.value.substring(end);
                    this.selectionStart = this.selectionEnd = start + 2;
                }
            });

            // Â§âÊõ¥„Ç§„Éô„É≥„Éà
            textarea.addEventListener('input', function () {
                updateStatusBar();
            });

            // „Çπ„ÉÜ„Éº„Çø„ÇπË°®Á§∫
            showMessage('CodeMirror„ÅåÂà©Áî®„Åß„Åç„Åæ„Åõ„Çì - Âü∫Êú¨„Ç®„Éá„Ç£„Çø„Éº„ÅßÂãï‰Ωú‰∏≠', 'error');
            document.getElementById('statusText').textContent = 'Expression Control - Fallback Editor';
        }

        // ‰∏çË¶Å„Å™Èñ¢Êï∞„ÇíÂâäÈô§Ôºà„Ç∑„É≥„Éó„É´„Å™„Ç®„Éá„Ç£„Çø„Éº„Å´Â§âÊõ¥Ôºâ

        // Enhanced EditorÊ©üËÉΩ„ÅØÂâäÈô§Ôºà„Ç∑„É≥„Éó„É´„Å™„Ç®„Éá„Ç£„Çø„Éº„Å´Â§âÊõ¥Ôºâ

        // „Ç®„Éá„Ç£„Çø„Éº„ÅÆ„Éò„É´„Éë„ÉºÈñ¢Êï∞
        function setEditorValue(value) {
            if (codeMirrorEditor) {
                codeMirrorEditor.dispatch({
                    changes: {
                        from: 0,
                        to: codeMirrorEditor.state.doc.length,
                        insert: value || ''
                    }
                });
            } else {
                // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„Ç®„Éá„Ç£„Çø„ÉºÁî®
                const textarea = document.getElementById('fallbackEditor');
                if (textarea) {
                    textarea.value = value || '';
                }
            }
        }

        function getEditorValue() {
            if (codeMirrorEditor) {
                return codeMirrorEditor.state.doc.toString();
            } else {
                // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„Ç®„Éá„Ç£„Çø„ÉºÁî®
                const textarea = document.getElementById('fallbackEditor');
                if (textarea) {
                    return textarea.value;
                }
                return '';
            }
        }

        // „Çπ„ÉÜ„Éº„Çø„Çπ„Éê„ÉºÊõ¥Êñ∞
        function updateStatusBar() {
            if (codeMirrorEditor) {
                const state = codeMirrorEditor.state;
                const selection = state.selection.main;
                const line = state.doc.lineAt(selection.head);
                const lineNumber = line.number;
                const column = selection.head - line.from + 1;
                document.getElementById('statusText').textContent =
                    `Expression Control - Ë°å: ${lineNumber}, Âàó: ${column}`;
            } else {
                // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„Ç®„Éá„Ç£„Çø„ÉºÁî®
                const textarea = document.getElementById('fallbackEditor');
                if (textarea && textarea.style.display !== 'none') {
                    const text = textarea.value;
                    const cursorPos = textarea.selectionStart;
                    const textBeforeCursor = text.substring(0, cursorPos);
                    const lineNumber = textBeforeCursor.split('\n').length;
                    const lastLineStart = textBeforeCursor.lastIndexOf('\n');
                    const column = cursorPos - lastLineStart;
                    document.getElementById('statusText').textContent =
                        `Expression Control - Ë°å: ${lineNumber}, Âàó: ${column}`;
                } else {
                    document.getElementById('statusText').textContent = 'Expression Control - Ready';
                }
            }
        }

        // ÂâäÈô§„Åï„Çå„ÅüÂè§„ÅÑÈñ¢Êï∞
        function oldInitializeBasicEditor() {
            var textarea = document.getElementById('expressionEditor');
            if (!textarea) return;

            // AE Expression „Ç≠„Éº„ÉØ„Éº„Éâ
            var aeKeywords = [
                'thisComp', 'thisLayer', 'time', 'value', 'wiggle', 'ease', 'linear',
                'position', 'scale', 'rotation', 'opacity', 'anchorPoint',
                'transform', 'width', 'height', 'index', 'name', 'parent',
                'valueAtTime', 'velocityAtTime', 'key', 'keyTime', 'keyValue'
            ];

            // „Ç®„É©„ÉºË°®Á§∫„Ç®„É™„Ç¢„Çí‰ΩúÊàê
            var errorDiv = document.createElement('div');
            errorDiv.id = 'expressionError';
            errorDiv.style.cssText = `
                color: #ff6b6b;
                font-size: 11px;
                margin-top: 5px;
                padding: 5px;
                background: #2a1f1f;
                border-radius: 3px;
                display: none;
            `;
            textarea.parentNode.appendChild(errorDiv);

            // ‰∫àÊ∏¨ÂÄôË£ú„Ç®„É™„Ç¢„Çí‰ΩúÊàê
            var suggestionsDiv = document.createElement('div');
            suggestionsDiv.id = 'suggestions';
            suggestionsDiv.style.cssText = `
                position: absolute;
                background: #2a2a2a;
                border: 1px solid #555;
                border-radius: 3px;
                max-height: 150px;
                overflow-y: auto;
                z-index: 1000;
                display: none;
                box-shadow: 0 4px 8px rgba(0,0,0,0.3);
                min-width: 200px;
                margin-top: 2px;
            `;
            textarea.parentNode.appendChild(suggestionsDiv);

            // „É™„Ç¢„É´„Çø„Ç§„É†Ê©üËÉΩ
            var currentSuggestions = [];
            var selectedSuggestionIndex = -1;

            // „Ç®„É©„Éº„ÉÅ„Çß„ÉÉ„ÇØÈñ¢Êï∞
            function checkErrors() {
                var text = textarea.value;
                var errors = [];

                // Êã¨Âºß„Éê„É©„É≥„Çπ„ÉÅ„Çß„ÉÉ„ÇØ
                var openParens = (text.match(/\(/g) || []).length;
                var closeParens = (text.match(/\)/g) || []).length;
                var openBrackets = (text.match(/\[/g) || []).length;
                var closeBrackets = (text.match(/\]/g) || []).length;

                if (openParens !== closeParens) errors.push('Êã¨Âºß () „ÅåÂêà„ÅÑ„Åæ„Åõ„Çì');
                if (openBrackets !== closeBrackets) errors.push('ËßíÊã¨Âºß [] „ÅåÂêà„ÅÑ„Åæ„Åõ„Çì');

                var errorDiv = document.getElementById('expressionError');
                if (errors.length > 0) {
                    errorDiv.innerHTML = '‚ö†Ô∏è ' + errors.join(', ');
                    errorDiv.style.display = 'block';
                } else {
                    errorDiv.style.display = 'none';
                }
            }

            // „Ç´„Éº„ÇΩ„É´‰ΩçÁΩÆ„ÇíÂèñÂæó„Åô„ÇãÈñ¢Êï∞
            function getCursorPosition() {
                var cursorPos = textarea.selectionStart;
                var textBefore = textarea.value.substring(0, cursorPos);
                var lines = textBefore.split('\n');
                var currentLine = lines.length - 1;
                var currentColumn = lines[lines.length - 1].length;

                // „ÉÜ„Ç≠„Çπ„Éà„Ç®„É™„Ç¢„ÅÆ‰ΩçÁΩÆ„Å®„Çµ„Ç§„Ç∫„ÇíÂèñÂæó
                var textareaRect = textarea.getBoundingClientRect();
                var style = window.getComputedStyle(textarea);
                var padding = parseInt(style.paddingLeft);
                var lineHeight = parseInt(style.lineHeight) || 18;
                var fontSize = parseInt(style.fontSize) || 13;

                // ÊñáÂ≠óÂπÖ„ÇíÊé®ÂÆöÔºàÁ≠âÂπÖ„Éï„Ç©„É≥„Éà„ÇíÂâçÊèêÔºâ
                var charWidth = fontSize * 0.6;

                // „Çπ„ÇØ„É≠„Éº„É´‰ΩçÁΩÆ„ÇíËÄÉÊÖÆ„Åó„Å¶„Ç´„Éº„ÇΩ„É´„ÅÆÁîªÈù¢‰∏ä„ÅÆ‰ΩçÁΩÆ„ÇíË®àÁÆó
                var x = textareaRect.left + padding + (currentColumn * charWidth);
                var y = textareaRect.top + padding + (currentLine * lineHeight) - textarea.scrollTop;

                return { x: x, y: y, lineHeight: lineHeight };
            }

            // ‰∫àÊ∏¨ÂÄôË£úË°®Á§∫
            function showSuggestions() {
                var cursorPos = textarea.selectionStart;
                var textBefore = textarea.value.substring(0, cursorPos);
                var words = textBefore.split(/[\s\(\)\[\]{}.,;]+/);
                var currentWord = words[words.length - 1] || '';

                if (currentWord.length < 2) {
                    suggestionsDiv.style.display = 'none';
                    return;
                }

                currentSuggestions = aeKeywords.filter(keyword =>
                    keyword.toLowerCase().startsWith(currentWord.toLowerCase()) &&
                    keyword !== currentWord
                );

                if (currentSuggestions.length === 0) {
                    suggestionsDiv.style.display = 'none';
                    return;
                }

                var html = currentSuggestions.slice(0, 8).map((suggestion, index) =>
                    `<div class="suggestion-item" style="padding: 6px 10px; cursor: pointer; font-family: monospace; border-bottom: 1px solid #3a3a3a; ${index === selectedSuggestionIndex ? 'background: #4a4a4a;' : ''}" data-index="${index}" onclick="insertSuggestion('${suggestion}')">${suggestion}</div>`
                ).join('');

                suggestionsDiv.innerHTML = html;

                // „Ç´„Éº„ÇΩ„É´‰ΩçÁΩÆ„ÇíÂèñÂæó„Åó„Å¶ÂÄôË£ú„ÅÆ‰ΩçÁΩÆ„ÇíË™øÊï¥
                var cursorPosition = getCursorPosition();
                var suggestionsHeight = Math.min(currentSuggestions.length * 28, 150); // È†ÖÁõÆ„ÅÆÈ´ò„Åï√óÂÄãÊï∞

                // ÁîªÈù¢„Çµ„Ç§„Ç∫„ÇíÂèñÂæó
                var windowHeight = window.innerHeight;
                var windowWidth = window.innerWidth;
                var suggestionsWidth = 200; // ÂÄôË£ú„Ç¶„Ç£„É≥„Éâ„Ç¶„ÅÆÂπÖ

                // ÁîªÈù¢„ÅÆ‰∏ãÈÉ®„Å´Ëøë„ÅÑÂ†¥Âêà„ÅØ‰∏ä„Å´Ë°®Á§∫„ÄÅ„Åù„ÅÜ„Åß„Å™„Åë„Çå„Å∞‰∏ã„Å´Ë°®Á§∫
                var showAbove = (cursorPosition.y + suggestionsHeight + 50) > windowHeight;

                // ÁîªÈù¢„ÅÆÂè≥Á´Ø„Åã„Çâ„ÅØ„ÅøÂá∫„Åï„Å™„ÅÑ„Çà„ÅÜ„Å´Ê®™‰ΩçÁΩÆ„ÇíË™øÊï¥
                var leftPosition = cursorPosition.x;
                if (leftPosition + suggestionsWidth > windowWidth) {
                    leftPosition = windowWidth - suggestionsWidth - 10;
                }
                if (leftPosition < 10) {
                    leftPosition = 10;
                }

                suggestionsDiv.style.position = 'fixed';
                suggestionsDiv.style.left = leftPosition + 'px';

                if (showAbove) {
                    // „Ç´„Éº„ÇΩ„É´„ÅÆ‰∏ä„Å´Ë°®Á§∫
                    suggestionsDiv.style.top = (cursorPosition.y - suggestionsHeight - 5) + 'px';
                } else {
                    // „Ç´„Éº„ÇΩ„É´„ÅÆ‰∏ã„Å´Ë°®Á§∫Ôºà„Éá„Éï„Ç©„É´„ÉàÔºâ
                    suggestionsDiv.style.top = (cursorPosition.y + cursorPosition.lineHeight + 5) + 'px';
                }

                suggestionsDiv.style.display = 'block';
            }

            // ÂÄôË£úÊåøÂÖ•
            window.insertSuggestion = function (suggestion) {
                var cursorPos = textarea.selectionStart;
                var textBefore = textarea.value.substring(0, cursorPos);
                var words = textBefore.split(/[\s\(\)\[\]{}.,;]+/);
                var currentWord = words[words.length - 1] || '';
                var replaceStart = cursorPos - currentWord.length;

                textarea.value = textarea.value.substring(0, replaceStart) + suggestion + textarea.value.substring(cursorPos);
                textarea.selectionStart = textarea.selectionEnd = replaceStart + suggestion.length;
                suggestionsDiv.style.display = 'none';
                textarea.focus();
            };

            // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
            textarea.addEventListener('input', function () {
                checkErrors();
                showSuggestions();
            });

            // „Çπ„ÇØ„É≠„Éº„É´ÊôÇ„Å´ÂÄôË£ú‰ΩçÁΩÆ„ÇíÊõ¥Êñ∞
            textarea.addEventListener('scroll', function () {
                if (suggestionsDiv.style.display === 'block') {
                    showSuggestions();
                }
            });

            textarea.addEventListener('keydown', function (e) {
                // Tab „Ç§„É≥„Éá„É≥„Éà
                if (e.key === 'Tab') {
                    e.preventDefault();
                    var start = this.selectionStart;
                    var end = this.selectionEnd;
                    this.value = this.value.substring(0, start) + '  ' + this.value.substring(end);
                    this.selectionStart = this.selectionEnd = start + 2;
                    return;
                }

                // Ctrl+Space „ÅßÂÄôË£úË°®Á§∫
                if (e.ctrlKey && e.key === ' ') {
                    e.preventDefault();
                    showSuggestions();
                    return;
                }

                // Escape „ÅßÂÄôË£ú„ÇíÈö†„Åô
                if (e.key === 'Escape') {
                    suggestionsDiv.style.display = 'none';
                    selectedSuggestionIndex = -1;
                    return;
                }

                // ÂÄôË£úÈÅ∏Êäû„ÅÆ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥
                if (suggestionsDiv.style.display === 'block') {
                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        selectedSuggestionIndex = Math.min(selectedSuggestionIndex + 1, currentSuggestions.length - 1);
                        showSuggestions();
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        selectedSuggestionIndex = Math.max(selectedSuggestionIndex - 1, -1);
                        showSuggestions();
                    } else if (e.key === 'Enter' && selectedSuggestionIndex >= 0) {
                        e.preventDefault();
                        insertSuggestion(currentSuggestions[selectedSuggestionIndex]);
                    }
                }
            });

            // Â§ñÈÉ®„ÇØ„É™„ÉÉ„ÇØ„ÅßÂÄôË£ú„ÇíÈö†„Åô
            document.addEventListener('click', function (e) {
                if (!e.target.closest('#suggestions') && e.target !== textarea) {
                    suggestionsDiv.style.display = 'none';
                    selectedSuggestionIndex = -1;
                }
            });

        }

        // ÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', function () {
            // „Ç∑„É≥„Çø„ÉÉ„ÇØ„Çπ„Éè„Ç§„É©„Ç§„Çø„Éº„ÇíÂàùÊúüÂåñ
            initializeSyntaxEditor();

            // CSInterfaceÂàùÊúüÂåñ
            if (typeof CSInterface !== 'undefined') {
                csInterface = new CSInterface();

                // ExtendScript„Éï„Ç°„Ç§„É´„Çí„É≠„Éº„Éâ
                var extensionRoot = csInterface.getSystemPath(SystemPath.EXTENSION);
                var jsxFile = extensionRoot + '/jsx/expressionControlAPI.jsx';

                console.log('Loading ExtendScript from:', jsxFile);
                csInterface.evalScript('$.evalFile("' + jsxFile + '")', function (result) {
                    console.log('ExtendScript load result:', result);
                    if (result && result !== 'undefined' && result !== '') {
                        console.error('ExtendScript loading error:', result);
                        document.getElementById('statusText').textContent = 'Expression Control - ExtendScript „Ç®„É©„Éº';
                    } else {
                        console.log('ExtendScript loaded successfully');
                        document.getElementById('statusText').textContent = 'Expression Control - Ê∫ñÂÇôÂÆå‰∫Ü';
                    }

                    // Èñ¢Êï∞„ÅåÊ≠£„Åó„ÅèË™≠„ÅøËæº„Åæ„Çå„Åü„Åã„ÉÜ„Çπ„Éà
                    csInterface.evalScript('typeof getSelectedLayers', function (typeResult) {
                        console.log('getSelectedLayers type:', typeResult);
                    });
                });
            } else {
                // CSInterface„ÅåÂà©Áî®„Åß„Åç„Å™„ÅÑÂ†¥ÂêàÔºàÈñãÁô∫ÊôÇ„Å™„Å©Ôºâ
                console.warn('CSInterface not available - running in mock mode');
                document.getElementById('statusText').textContent = 'Expression Control - Mock Mode';
            }
        });

        // This Layer(s) „Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØ
        function refreshLayers() {
            console.log('refreshLayers called');
            document.getElementById('layerInfo').textContent = 'üîÑ „É¨„Ç§„É§„ÉºÊÉÖÂ†±„ÇíÊõ¥Êñ∞‰∏≠...';

            // This Layer(s)„Éú„Çø„É≥„ÅåÊäº„Åï„Çå„Åü„Å®„Åç„Ç®„ÇØ„Çπ„Éó„É¨„ÉÉ„Ç∑„Éß„É≥„Ç®„Éá„Ç£„Çø„Éº„Çí„ÇØ„É™„Ç¢
            setEditorValue('');
            currentProperty = null;

            if (!csInterface) {
                console.log('CSInterface not available - using mock mode');
                showMessage('Mock Mode: „É¨„Ç§„É§„ÉºÊÉÖÂ†±„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü', 'success');
                document.getElementById('layerInfo').textContent = '‚úÖ Mock: ÈÅ∏Êäû„Åï„Çå„Åü„É¨„Ç§„É§„Éº';
                return;
            }

            console.log('CSInterface available, calling ExtendScript...');

            // „É¨„Ç§„É§„ÉºÊÉÖÂ†±ÂèñÂæó„ÅÆÂá¶ÁêÜÔºàÁúÅÁï• - Êó¢Â≠ò„Ç≥„Éº„Éâ„Çí„Åù„ÅÆ„Åæ„Åæ‰ΩøÁî®Ôºâ
            csInterface.evalScript('app.project.activeItem ? "OK" : "NO_COMP"', function (testResult) {
                console.log('ExtendScript test result:', testResult);

                if (testResult === 'NO_COMP') {
                    showMessage('„Ç≥„É≥„Éù„Ç∏„Ç∑„Éß„É≥„Çí„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                    document.getElementById('layerInfo').textContent = '‚ùå „Ç®„É©„Éº: „Ç≥„É≥„Éù„Ç∏„Ç∑„Éß„É≥„Åå„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì';
                    return;
                }

                csInterface.evalScript('typeof getSelectedLayers !== "undefined" ? "API_OK" : "API_NOT_LOADED"', function (apiResult) {
                    console.log('API test result:', apiResult);

                    if (apiResult === 'API_NOT_LOADED') {
                        showMessage('ExtendScriptÈñ¢Êï∞„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì', 'error');
                        document.getElementById('layerInfo').textContent = '‚ùå „Ç®„É©„Éº: Èñ¢Êï∞„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì';
                        return;
                    }

                    csInterface.evalScript('getSelectedLayers()', function (result) {
                        console.log('getSelectedLayers result:', result);

                        if (result.indexOf('ERROR:') === 0) {
                            var errorMsg = result.substring(6);
                            showMessage(errorMsg, 'error');
                            document.getElementById('layerInfo').textContent = '‚ùå „Ç®„É©„Éº: ' + errorMsg;
                            return;
                        }

                        if (result.indexOf('SUCCESS:') === 0) {
                            var parts = result.split('|');
                            var count = parseInt(parts[0].substring(8));

                            selectedLayers = [];
                            for (var i = 1; i < parts.length; i++) {
                                var layerParts = parts[i].split(':');
                                if (layerParts.length >= 2) {
                                    selectedLayers.push({
                                        index: parseInt(layerParts[0]),
                                        name: layerParts.slice(1).join(':')
                                    });
                                }
                            }

                            updateLayerInfo({ count: count, layers: selectedLayers });
                            loadProperties();
                        } else {
                            console.error('Unexpected result format:', result);
                            showMessage('‰∫àÊúü„Åó„Å™„ÅÑÁµêÊûúÂΩ¢Âºè„Åß„Åô', 'error');
                            document.getElementById('layerInfo').textContent = '‚ùå ÂΩ¢Âºè„Ç®„É©„Éº';
                        }
                    });
                });
            });
        }

        function updateLayerInfo(data) {
            var layerInfo = document.getElementById('layerInfo');
            if (data.count === 1) {
                layerInfo.textContent = `‚úÖ „É¨„Ç§„É§„Éº: ${data.layers[0].name}`;
            } else {
                layerInfo.textContent = `‚úÖ ÈÅ∏Êäû„É¨„Ç§„É§„Éº: ${data.count}ÂÄã`;
            }
        }

        function loadProperties() {
            if (selectedLayers.length === 0) {
                return;
            }

            if (selectedLayers.length === 1) {
                var layerIndex = selectedLayers[0].index;
                csInterface.evalScript('debugLayerInfo(' + layerIndex + ')', function (debugResult) {
                    console.log('Layer debug info:', debugResult);
                    csInterface.evalScript('listVisibleExpressionProps(' + layerIndex + ')', function (result) {
                        handlePropertiesResult(result, false);
                    });
                });
            } else {
                var layerIndices = selectedLayers.map(function (layer) { return layer.index; });
                console.log('Loading common properties for layers:', layerIndices);
                csInterface.evalScript('listCommonExpressionProps([' + layerIndices.join(',') + '])', function (result) {
                    console.log('Common properties result:', result);
                    handlePropertiesResult(result, true);
                });
            }
        }

        function handlePropertiesResult(result, isCommonProps) {
            console.log('Properties result:', result);

            if (result.indexOf('ERROR:') === 0) {
                var errorMsg = result.substring(6);
                showMessage(errorMsg, 'error');
                return;
            }

            if (result.indexOf('SUCCESS:') === 0) {
                var parts = result.split('|');
                var successPart = parts[0].substring(8);
                var count = parseInt(successPart);

                if (parts[1] && parts[1].indexOf('DEBUG:') === 0) {
                    var debugInfo = parts[1].substring(6);
                    console.log('Property scan debug:', debugInfo);
                    if (isCommonProps) {
                        document.getElementById('statusText').textContent = `ÂÖ±ÈÄö„Éó„É≠„Éë„ÉÜ„Ç£: ${debugInfo}`;
                    } else {
                        document.getElementById('statusText').textContent = `„Éá„Éê„ÉÉ„Ç∞: ${debugInfo}`;
                    }
                }

                allProperties = [];
                var existingExpressions = [];

                var startIndex = parts[1] && parts[1].indexOf('DEBUG:') === 0 ? 2 : 1;

                for (var i = startIndex; i < parts.length; i += 2) {
                    if (i + 1 < parts.length &&
                        parts[i].indexOf('PROP:') === 0 &&
                        parts[i + 1].indexOf('EXPR:') === 0) {

                        var propName = parts[i].substring(5);
                        var hasExpression = parts[i + 1].substring(5) === '1';

                        var prop = {
                            name: propName,
                            hasExpression: hasExpression,
                            layerIndex: selectedLayers.length === 1 ? selectedLayers[0].index : -1,
                            isCommon: isCommonProps
                        };

                        allProperties.push(prop);

                        if (hasExpression) {
                            existingExpressions.push(prop);
                        }
                    }
                }

                console.log('Parsed properties:', allProperties);
                console.log('Parsed existing expressions:', existingExpressions);

                updatePropertyDropdowns(allProperties, existingExpressions);

                if (count === 0) {
                    if (isCommonProps) {
                        showMessage('ÈÅ∏Êäû„Åó„Åü„É¨„Ç§„É§„Éº„Å´ÂÖ±ÈÄö„Åô„Çã„Éó„É≠„Éë„ÉÜ„Ç£„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ', 'error');
                    } else {
                        showMessage('„Éó„É≠„Éë„ÉÜ„Ç£„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ„Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
                    }
                } else {
                    if (isCommonProps) {
                        showMessage(`${count}ÂÄã„ÅÆÂÖ±ÈÄö„Éó„É≠„Éë„ÉÜ„Ç£„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü (${selectedLayers.length}„É¨„Ç§„É§„Éº)`, 'success');
                    } else {
                        showMessage(`${count}ÂÄã„ÅÆ„Éó„É≠„Éë„ÉÜ„Ç£„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü (ÂÆüÈöõ: ${allProperties.length}ÂÄã)`, 'success');
                    }
                }
            }
        }

        function updatePropertyDropdowns(allProps, existingExprs) {
            // ÂÖ®„Éó„É≠„Éë„ÉÜ„Ç£„Ç´„Çπ„Çø„É†„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥
            var allPropsList = document.getElementById('allPropsList');
            allPropsList.innerHTML = '';

            for (var i = 0; i < allProps.length; i++) {
                var item = document.createElement('div');
                item.className = 'dropdown-item';
                item.textContent = allProps[i].name;
                item.onclick = (function (index) {
                    return function () {
                        selectCustomProperty('allProps', index);
                    };
                })(i);
                allPropsList.appendChild(item);
            }

            // Êó¢Â≠ò„Ç®„ÇØ„Çπ„Éó„É¨„ÉÉ„Ç∑„Éß„É≥„Ç´„Çπ„Çø„É†„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥
            var existingExprsList = document.getElementById('existingExprsList');
            existingExprsList.innerHTML = '';

            window.existingExpressions = existingExprs;

            for (var j = 0; j < existingExprs.length; j++) {
                var item = document.createElement('div');
                item.className = 'dropdown-item';
                item.textContent = existingExprs[j].name;
                item.onclick = (function (index) {
                    return function () {
                        selectCustomProperty('existingExprs', index);
                    };
                })(j);
                existingExprsList.appendChild(item);
            }

            // ÈÅ∏Êäû„Çí„É™„Çª„ÉÉ„Éà
            document.getElementById('allPropsSelected').textContent = '„Éó„É≠„Éë„ÉÜ„Ç£„ÇíÈÅ∏Êäû...';
            document.getElementById('existingExprsSelected').textContent = '-----';
        }

        // „Ç´„Çπ„Çø„É†„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„ÅÆÂà∂Âæ°Èñ¢Êï∞
        function toggleDropdown(dropdownType) {
            var listId = dropdownType === 'allProps' ? 'allPropsList' : 'existingExprsList';
            var buttonId = dropdownType === 'allProps' ? 'allPropsCustomDropdown' : 'existingExprsCustomDropdown';

            var list = document.getElementById(listId);
            var button = document.querySelector('#' + buttonId + ' .dropdown-button');
            var section = document.getElementById(buttonId).closest('.section');

            closeAllDropdowns();

            if (list.classList.contains('show')) {
                list.classList.remove('show');
                button.classList.remove('open');
                section.classList.remove('dropdown-open');
            } else {
                list.classList.add('show');
                button.classList.add('open');
                section.classList.add('dropdown-open');
            }
        }

        function closeAllDropdowns() {
            var dropdowns = document.querySelectorAll('.dropdown-list');
            var buttons = document.querySelectorAll('.dropdown-button');
            var sections = document.querySelectorAll('.section');

            dropdowns.forEach(function (dropdown) {
                dropdown.classList.remove('show');
            });

            buttons.forEach(function (button) {
                button.classList.remove('open');
            });

            sections.forEach(function (section) {
                section.classList.remove('dropdown-open');
            });
        }

        function selectCustomProperty(dropdownType, index) {
            if (dropdownType === 'allProps') {
                if (allProperties[index]) {
                    var selectedProp = allProperties[index];
                    currentProperty = selectedProp;
                    document.getElementById('allPropsSelected').textContent = selectedProp.name;
                    document.getElementById('statusText').textContent = `„Éó„É≠„Éë„ÉÜ„Ç£ÈÅ∏Êäû: ${selectedProp.name}`;

                    var matchingExistingIndex = -1;
                    if (window.existingExpressions) {
                        for (var i = 0; i < window.existingExpressions.length; i++) {
                            if (window.existingExpressions[i].name === selectedProp.name) {
                                matchingExistingIndex = i;
                                break;
                            }
                        }
                    }

                    if (matchingExistingIndex >= 0) {
                        var existingProp = window.existingExpressions[matchingExistingIndex];
                        document.getElementById('existingExprsSelected').textContent = existingProp.name;

                        csInterface.evalScript('getExpressionContent(' + existingProp.layerIndex + ', "' + existingProp.name + '")', function (result) {
                            console.log('Expression content result:', result);
                            if (result.indexOf('SUCCESS:') === 0) {
                                var expression = result.substring(8);
                                setEditorValue(expression);
                                showMessage('Êó¢Â≠ò„Ç®„ÇØ„Çπ„Éó„É¨„ÉÉ„Ç∑„Éß„É≥„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü', 'success');
                            }
                        });
                    } else {
                        document.getElementById('existingExprsSelected').textContent = '-----';
                        setEditorValue('');
                        showMessage(`${selectedProp.name} „ÇíÈÅ∏Êäû„Åó„Åæ„Åó„Åü`, 'success');
                    }
                }
            } else if (dropdownType === 'existingExprs') {
                if (window.existingExpressions && window.existingExpressions[index]) {
                    var existingProp = window.existingExpressions[index];
                    currentProperty = existingProp;
                    document.getElementById('existingExprsSelected').textContent = existingProp.name;

                    var matchingAllPropsIndex = -1;
                    if (allProperties) {
                        for (var j = 0; j < allProperties.length; j++) {
                            if (allProperties[j].name === existingProp.name) {
                                matchingAllPropsIndex = j;
                                break;
                            }
                        }
                    }

                    if (matchingAllPropsIndex >= 0) {
                        document.getElementById('allPropsSelected').textContent = existingProp.name;
                    }

                    csInterface.evalScript('getExpressionContent(' + existingProp.layerIndex + ', "' + existingProp.name + '")', function (result) {
                        console.log('Expression content result:', result);

                        if (result.indexOf('SUCCESS:') === 0) {
                            var expression = result.substring(8);
                            setEditorValue(expression);
                            showMessage('Êó¢Â≠ò„Ç®„ÇØ„Çπ„Éó„É¨„ÉÉ„Ç∑„Éß„É≥„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü', 'success');
                        } else if (result.indexOf('ERROR:') === 0) {
                            showMessage('„Ç®„ÇØ„Çπ„Éó„É¨„ÉÉ„Ç∑„Éß„É≥Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº: ' + result.substring(6), 'error');
                        }
                    });

                    document.getElementById('statusText').textContent = `Êó¢Â≠ò„Ç®„ÇØ„Çπ„Éó„É¨„ÉÉ„Ç∑„Éß„É≥: ${existingProp.name}`;
                }
            }

            closeAllDropdowns();
        }

        // Â§ñÈÉ®„ÇØ„É™„ÉÉ„ÇØ„Åß„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„ÇíÈñâ„Åò„Çã
        document.addEventListener('click', function (event) {
            if (!event.target.closest('.custom-dropdown')) {
                closeAllDropdowns();
            }
        });

        function applyExpression() {
            var expression = getEditorValue();

            if (!expression || expression.trim() === '') {
                showMessage('„Ç®„ÇØ„Çπ„Éó„É¨„ÉÉ„Ç∑„Éß„É≥„ÅåÁ©∫„Åß„Åô', 'error');
                return;
            }

            if (!currentProperty) {
                showMessage('„Éó„É≠„Éë„ÉÜ„Ç£„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì', 'error');
                return;
            }

            if (selectedLayers.length === 0) {
                showMessage('„É¨„Ç§„É§„Éº„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì', 'error');
                return;
            }

            if (!csInterface) {
                showMessage('üöÄ Mock: „Ç®„ÇØ„Çπ„Éó„É¨„ÉÉ„Ç∑„Éß„É≥„ÇíÈÅ©Áî®„Åó„Åæ„Åó„ÅüÔºÅ', 'success');
                return;
            }

            showMessage('üöÄ „Ç®„ÇØ„Çπ„Éó„É¨„ÉÉ„Ç∑„Éß„É≥„ÇíÈÅ©Áî®‰∏≠...', 'success');

            // ÈÅ∏Êäû„Åï„Çå„ÅüÂÖ®„Å¶„ÅÆ„É¨„Ç§„É§„Éº„Å´ÈÅ©Áî®
            var applyCount = 0;
            var errorCount = 0;

            function applyToNextLayer(index) {
                if (index >= selectedLayers.length) {
                    if (errorCount === 0) {
                        showMessage(`‚úÖ ${applyCount}ÂÄã„ÅÆ„É¨„Ç§„É§„Éº„Å´„Ç®„ÇØ„Çπ„Éó„É¨„ÉÉ„Ç∑„Éß„É≥„ÇíÈÅ©Áî®„Åó„Åæ„Åó„Åü`, 'success');
                    } else {
                        showMessage(`‚ö†Ô∏è ${applyCount}ÂÄãÊàêÂäü„ÄÅ${errorCount}ÂÄã„Ç®„É©„Éº`, 'error');
                    }

                    loadProperties();
                    return;
                }

                var layer = selectedLayers[index];
                var scriptCall = 'applyExpressionToProperty(' + layer.index + ', "' + currentProperty.name + '", ' + JSON.stringify(expression) + ')';

                csInterface.evalScript(scriptCall, function (result) {
                    console.log('Apply result for layer', layer.index, ':', result);

                    if (result.indexOf('SUCCESS:') === 0) {
                        applyCount++;
                    } else {
                        errorCount++;
                        console.error('Apply error:', result);
                    }

                    applyToNextLayer(index + 1);
                });
            }

            if (selectedLayers.length > 1) {
                console.log('Applying expression to', selectedLayers.length, 'layers for common property:', currentProperty.name);
            }

            applyToNextLayer(0);
        }

        function showMessage(message, type) {
            var successMsg = document.getElementById('successMessage');
            var errorMsg = document.getElementById('errorMessage');

            successMsg.style.display = 'none';
            errorMsg.style.display = 'none';

            if (type === 'success') {
                successMsg.textContent = message;
                successMsg.style.display = 'block';

                setTimeout(function () {
                    successMsg.style.display = 'none';
                }, 3000);
            } else if (type === 'error') {
                errorMsg.textContent = message;
                errorMsg.style.display = 'block';

                setTimeout(function () {
                    errorMsg.style.display = 'none';
                }, 5000);
            }
        }
    </script>
</body>

</html>