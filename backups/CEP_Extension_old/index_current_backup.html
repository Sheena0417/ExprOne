<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expression Control</title>

    <!-- Monaco Editor - Alternative CDN -->
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/loader.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #2a2a2a;
            color: #ffffff;
            margin: 0;
            padding: 15px;
            font-size: 13px;
        }

        .container {
            max-width: 100%;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
        }

        .header h1 {
            margin: 0;
            font-size: 18px;
            color: #FFE082;
        }

        .section {
            margin-bottom: 15px;
        }

        .section label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #BDBDBD;
            font-size: 12px;
        }

        .main-button {
            width: 100%;
            padding: 12px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .main-button:hover {
            background: #45a049;
        }

        .dropdown {
            width: 100%;
            padding: 8px;
            background: #3a3a3a;
            color: white;
            border: 1px solid #555;
            border-radius: 3px;
            font-size: 12px;
            position: relative;
            z-index: 1000;
            max-height: 200px;
            /* é«˜ã•åˆ¶é™ */
            overflow-y: auto;
            /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æœ‰åŠ¹ */
        }

        .dropdown:focus {
            outline: none;
            border-color: #4CAF50;
            z-index: 1001;
        }

        /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³é–“ã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç¢ºä¿ */
        .section {
            margin-bottom: 15px;
            position: relative;
            z-index: 10;
        }

        /* ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãŒé–‹ã„ã¦ã„ã‚‹æ™‚ã«ä»–ã®è¦ç´ ã‚ˆã‚Šå‰é¢ã« */
        .section:focus-within {
            z-index: 99998;
        }

        /* ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãŒé–‹ã„ã¦ã„ã‚‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æœ€å‰é¢ã« */
        .section.dropdown-open {
            z-index: 99998;
        }

        /* ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .custom-dropdown {
            position: relative;
            width: 100%;
        }

        .dropdown-button {
            width: 100%;
            padding: 8px 12px;
            background: #3a3a3a;
            color: white;
            border: 1px solid #555;
            border-radius: 3px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-sizing: border-box;
        }

        .dropdown-button:hover {
            background: #4a4a4a;
            border-color: #4CAF50;
        }

        .dropdown-arrow {
            font-size: 10px;
            transition: transform 0.2s;
        }

        .dropdown-button.open .dropdown-arrow {
            transform: rotate(180deg);
        }

        .dropdown-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #2a2a2a;
            border: 1px solid #555;
            border-top: none;
            border-radius: 0 0 3px 3px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 99999;
            /* éå¸¸ã«é«˜ã„å€¤ã«è¨­å®š */
            display: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            /* å½±ã‚’è¿½åŠ ã—ã¦å‰é¢æ„Ÿã‚’å¼·èª¿ */
        }

        .dropdown-list.show {
            display: block;
        }

        .dropdown-item {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 12px;
            border-bottom: 1px solid #3a3a3a;
        }

        .dropdown-item:hover {
            background: #4a4a4a;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item.selected {
            background: #4CAF50;
            color: white;
        }

        .expression-input {
            width: 100%;
            height: 120px;
            padding: 10px;
            background: #1a1a1a;
            color: #ffffff;
            border: 1px solid #555;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            resize: vertical;
        }

        .expression-input:focus {
            outline: none;
            border-color: #4CAF50;
        }

        /* Monaco Editor container */
        #monacoContainer {
            width: 100%;
            height: 150px;
            min-height: 150px;
            border: 1px solid #555;
            border-radius: 3px;
            background: #1a1a1a;
            position: relative;
            box-sizing: border-box;
        }

        /* Enhanced Editor styles */
        .enhanced-editor {
            width: 100%;
            height: 160px;
            padding: 10px;
            background: #1a1a1a;
            color: #ffffff;
            border: 1px solid #555;
            border-radius: 3px;
            font-family: 'Courier New', 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            line-height: 1.4;
            resize: vertical;
            tab-size: 2;
            box-sizing: border-box;
        }

        .enhanced-editor:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 5px rgba(76, 175, 80, 0.3);
        }

        .apply-button {
            width: 100%;
            padding: 12px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
        }

        .apply-button:hover {
            background: #1976D2;
        }

        .apply-button:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .info-text {
            padding: 8px;
            background: #333;
            border-radius: 3px;
            color: #BDBDBD;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .messages {
            margin-top: 15px;
        }

        .success-message {
            background: rgba(76, 175, 80, 0.3);
            border: 1px solid #4CAF50;
            color: #C8E6C9;
            padding: 10px;
            border-radius: 3px;
            display: none;
            font-size: 12px;
        }

        .error-message {
            background: rgba(244, 67, 54, 0.3);
            border: 1px solid #F44336;
            color: #FFCDD2;
            padding: 10px;
            border-radius: 3px;
            display: none;
            font-size: 12px;
        }

        .status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #1a1a1a;
            padding: 5px 15px;
            border-top: 1px solid #444;
            font-size: 11px;
            color: #888;
            z-index: 100;
            /* ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚ˆã‚Šä½ã„å€¤ */
        }

        /* ã‚³ãƒ³ãƒ†ãƒŠã®ä¸‹éƒ¨ãƒãƒ¼ã‚¸ãƒ³ã‚’è¿½åŠ ã—ã¦ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ã¨é‡ãªã‚‰ãªã„ã‚ˆã†ã« */
        .container {
            max-width: 100%;
            padding-bottom: 30px;
            /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼åˆ†ã®ã‚¹ãƒšãƒ¼ã‚¹ */
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>Expression Control</h1>
        </div>

        <!-- This Layer(s) ãƒœã‚¿ãƒ³ -->
        <div class="section">
            <button id="thisLayersBtn" onclick="refreshLayers()" class="main-button">This Layer(s)</button>
            <div id="layerInfo" class="info-text">ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’é¸æŠã—ã¦ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</div>
        </div>

        <!-- ã‚¨ã‚¯ã‚¹ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³å¯èƒ½ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ä¸€è¦§ -->
        <div class="section">
            <label>ã‚¨ã‚¯ã‚¹ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³å¯èƒ½ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£:</label>
            <div class="custom-dropdown" id="allPropsCustomDropdown">
                <div class="dropdown-button" onclick="toggleDropdown('allProps')">
                    <span id="allPropsSelected">ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’é¸æŠ...</span>
                    <span class="dropdown-arrow">â–¼</span>
                </div>
                <div class="dropdown-list" id="allPropsList">
                    <!-- ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                </div>
            </div>
        </div>

        <!-- æ—¢å­˜ã‚¨ã‚¯ã‚¹ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§ -->
        <div class="section">
            <label>æ—¢å­˜ã‚¨ã‚¯ã‚¹ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³:</label>
            <div class="custom-dropdown" id="existingExprsCustomDropdown">
                <div class="dropdown-button" onclick="toggleDropdown('existingExprs')">
                    <span id="existingExprsSelected">-----</span>
                    <span class="dropdown-arrow">â–¼</span>
                </div>
                <div class="dropdown-list" id="existingExprsList">
                    <!-- æ—¢å­˜ã‚¨ã‚¯ã‚¹ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                </div>
            </div>
        </div>

        <!-- ã‚¨ã‚¯ã‚¹ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³è¨˜å…¥æ¬„ -->
        <div class="section">
            <label>ã‚¨ã‚¯ã‚¹ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³:</label>
            <div id="monacoContainer"></div>
            <!-- å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ã«éš ã—textareaã‚’ä¿æŒ -->
            <textarea id="expressionEditor" style="display: none;"></textarea>
        </div>

        <!-- Apply ãƒœã‚¿ãƒ³ -->
        <div class="section">
            <button id="applyBtn" onclick="applyExpression()" class="apply-button">Apply</button>
        </div>

        <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º -->
        <div class="messages">
            <div class="success-message" id="successMessage"></div>
            <div class="error-message" id="errorMessage"></div>
        </div>
    </div>

    <div class="status-bar">
        <span id="statusText">Expression Control - Ready</span>
    </div>

    <!-- CEP Communication Library -->
    <script src="js/CSInterface.js"></script>

    <script>
        // CEP Interface
        var csInterface;
        var selectedLayers = [];
        var allProperties = [];
        var currentProperty = null;

        // ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼å¤‰æ•°
        let monacoEditor = null;
        let enhancedEditor = null;

        // Monaco Editorã®åˆæœŸåŒ–
        function initializeMonacoEditor() {
            try {
                console.log('Starting Monaco Editor initialization...');

                // Monaco Editorã®CDNé…ä¿¡ãƒ‘ã‚¹ã‚’è¨­å®š
                require.config({
                    paths: {
                        'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs'
                    }
                });

                require(['vs/editor/editor.main'], function () {
                    console.log('Monaco Editor loaded, creating editor...');
                    // After Effects Expressionç”¨ã®ã‚«ã‚¹ã‚¿ãƒ è¨€èªè¨­å®š
                    monaco.languages.register({ id: 'ae-expression' });

                    // ã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ãƒã‚¤ãƒ©ã‚¤ãƒˆè¨­å®š
                    monaco.languages.setMonarchTokensProvider('ae-expression', {
                        tokenizer: {
                            root: [
                                [/\b(thisComp|thisLayer|time|value|wiggle|ease|linear|key|marker|effect|transform|position|scale|rotation|opacity|anchorPoint|width|height|index|name|parent|source|inPoint|outPoint|startTime|duration|frameDuration|comp|layer|property|propertyGroup|numKeys|keyTime|keyValue|velocityAtTime|speedAtTime|temporalEase|spatialTangent|isSpatial|canSetExpression|expression|expressionEnabled|valueAtTime|nearestKeyIndex|keyIndex|keyTime|numProperties|propertyIndex|propertyName|matchName|isEffect|isLayer|active|enabled|hasParent|inPoint|outPoint|startTime|stretch|timeRemap|blendingMode|trackMatteType|hasTrackMatte|isTrackMatte|preserveTransparency|quality|motionBlur|frameBlending|threeDLayer|environmentLayer|collapseTransformation|frameRate|pixelAspect|shutterAngle|shutterPhase|workAreaStart|workAreaDuration|numLayers|activeCamera|displayStartTime|footageMissing|frameBlending|motionBlur|shutterAngle|shutterPhase|bgColor|activeCamera|cameraOption|lightOption)\b/, 'keyword'],
                                [/\b(var|function|if|else|for|while|do|switch|case|default|break|continue|return|try|catch|finally|throw|new|delete|typeof|instanceof|in|with|true|false|null|undefined|this)\b/, 'keyword'],
                                [/\b\d+\.?\d*\b/, 'number'],
                                [/".*?"/, 'string'],
                                [/'.*?'/, 'string'],
                                [/\/\/.*$/, 'comment'],
                                [/\/\*[\s\S]*?\*\//, 'comment'],
                                [/[{}()\[\]]/, 'bracket'],
                                [/[;,.]/, 'delimiter'],
                                [/[+\-*/=<>!&|?:]/, 'operator'],
                            ]
                        }
                    });

                    // ãƒ†ãƒ¼ãƒè¨­å®š
                    monaco.editor.defineTheme('ae-dark', {
                        base: 'vs-dark',
                        inherit: true,
                        rules: [
                            { token: 'keyword', foreground: '569CD6' },
                            { token: 'string', foreground: 'CE9178' },
                            { token: 'comment', foreground: '6A9955' },
                            { token: 'number', foreground: 'B5CEA8' },
                            { token: 'operator', foreground: 'D4D4D4' },
                        ],
                        colors: {
                            'editor.background': '#1a1a1a',
                            'editor.foreground': '#ffffff',
                            'editorLineNumber.foreground': '#858585',
                            'editor.selectionBackground': '#264f78',
                            'editor.lineHighlightBackground': '#2a2a2a'
                        }
                    });

                    // ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ä½œæˆ
                    console.log('Creating Monaco Editor...');
                    var container = document.getElementById('monacoContainer');
                    console.log('Monaco container element:', container);

                    if (!container) {
                        console.error('Monaco container not found!');
                        return;
                    }

                    monacoEditor = monaco.editor.create(container, {
                        value: '',
                        language: 'ae-expression',
                        theme: 'ae-dark',
                        fontSize: 12,
                        lineNumbers: 'on',
                        automaticLayout: true,
                        minimap: { enabled: false },
                        scrollBeyondLastLine: false,
                        wordWrap: 'on',
                        lineDecorationsWidth: 10,
                        lineNumbersMinChars: 3,
                        glyphMargin: false,
                        folding: false,
                        // After Effects Expressionç”¨ã®ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆ
                        suggest: {
                            showKeywords: true,
                            showSnippets: true,
                            showFunctions: true,
                            showVariables: true,
                            showWords: true,
                        },
                        quickSuggestions: {
                            other: true,
                            comments: false,
                            strings: false
                        }
                    });

                    // ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼å†…å®¹å¤‰æ›´æ™‚ã«éš ã—textareaã¨åŒæœŸ
                    monacoEditor.onDidChangeModelContent(function () {
                        document.getElementById('expressionEditor').value = monacoEditor.getValue();
                    });

                    console.log('Monaco Editor initialized successfully');

                    // Monaco Editorã®çŠ¶æ…‹ã‚’ãƒ‡ãƒãƒƒã‚°
                    console.log('Monaco Editor instance:', monacoEditor);
                    console.log('Monaco container:', document.getElementById('monacoContainer'));

                    // ã‚³ãƒ³ãƒ†ãƒŠãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
                    var container = document.getElementById('monacoContainer');
                    if (container) {
                        console.log('Container dimensions:', {
                            width: container.offsetWidth,
                            height: container.offsetHeight,
                            display: getComputedStyle(container).display,
                            visibility: getComputedStyle(container).visibility
                        });
                    }

                    // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’å¼·åˆ¶æ›´æ–°
                    setTimeout(() => {
                        if (monacoEditor) {
                            monacoEditor.layout();
                            console.log('Monaco Editor layout updated');
                        }
                    }, 200);
                }, function (error) {
                    console.error('Failed to load Monaco Editor:', error);
                    showFallbackEditor();
                });
            } catch (error) {
                console.error('Monaco Editor initialization error:', error);
                showFallbackEditor();
            }
        }

        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: é€šå¸¸ã®textareaã‚’è¡¨ç¤º
        function showFallbackEditor() {
            console.log('Using fallback textarea editor');
            console.log('Monaco Editor failed to initialize - showing textarea fallback');

            document.getElementById('monacoContainer').style.display = 'none';
            var textarea = document.getElementById('expressionEditor');
            textarea.style.display = 'block';
            textarea.className = 'expression-input';
            textarea.placeholder = 'ã‚¨ã‚¯ã‚¹ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ã‚’å…¥åŠ›... (Monaco Editor fallback)';
            textarea.rows = 6;

            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
            var statusDiv = document.createElement('div');
            statusDiv.style.cssText = 'color: orange; font-size: 11px; margin-top: 5px;';
            statusDiv.textContent = 'Monaco EditorãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ - é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã§å‹•ä½œä¸­';
            document.getElementById('monacoContainer').parentNode.appendChild(statusDiv);
        }

        // Monaco Editorã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function setMonacoValue(value) {
            if (monacoEditor) {
                monacoEditor.setValue(value || '');
            }
            // å¸¸ã«éš ã—textareaã‚‚æ›´æ–°ï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
            document.getElementById('expressionEditor').value = value || '';
        }

        function getMonacoValue() {
            if (monacoEditor) {
                return monacoEditor.getValue();
            }
            return document.getElementById('expressionEditor').value;
        }

        // æ‹¡å¼µã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã®åˆæœŸåŒ–ï¼ˆMonaco Editorã®ä»£æ›¿ï¼‰
        function initializeEnhancedEditor() {
            console.log('Initializing Enhanced Editor...');

            // Monaco EditorãŒã‚ã‚‹å ´åˆã¯å…ˆã«ãã‚Œã‚’è©¦ã™
            if (typeof require !== 'undefined') {
                console.log('Trying Monaco Editor first...');
                initializeMonacoEditor();
                return;
            }

            // Monaco EditorãŒä½¿ãˆãªã„å ´åˆã¯æ‹¡å¼µtextarea
            showEnhancedTextarea();
        }

        // æ‹¡å¼µtextareaã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã‚’è¡¨ç¤º
        function showEnhancedTextarea() {
            console.log('Using Enhanced Textarea Editor');

            // Monaco Editorã‚³ãƒ³ãƒ†ãƒŠã‚’éš ã™
            document.getElementById('monacoContainer').style.display = 'none';

            // textareaã‚’è¡¨ç¤ºã—ã¦æ©Ÿèƒ½å¼·åŒ–
            var textarea = document.getElementById('expressionEditor');
            textarea.style.display = 'block';
            textarea.className = 'expression-input enhanced-editor';
            textarea.placeholder = 'ã‚¨ã‚¯ã‚¹ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ã‚’å…¥åŠ›... (Enhanced Editor)';
            textarea.rows = 8;

            // ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼æ©Ÿèƒ½ã‚’è¿½åŠ 
            enhanceTextarea(textarea);
            enhancedEditor = textarea;

            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            console.log('Enhanced Textarea Editor initialized successfully');
        }

        // textareaã«é«˜æ©Ÿèƒ½ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼æ©Ÿèƒ½ã‚’è¿½åŠ 
        function enhanceTextarea(textarea) {
            // ã‚¿ãƒ–ã‚­ãƒ¼ã§ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆ
            textarea.addEventListener('keydown', function (e) {
                if (e.key === 'Tab') {
                    e.preventDefault();
                    var start = this.selectionStart;
                    var end = this.selectionEnd;
                    this.value = this.value.substring(0, start) + '  ' + this.value.substring(end);
                    this.selectionStart = this.selectionEnd = start + 2;
                }
            });

            // ã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹æ¤œè¨¼
            textarea.addEventListener('blur', function () {
                validateExpression(this.value);
            });
        }

        // ç°¡æ˜“ã‚¨ã‚¯ã‚¹ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³æ¤œè¨¼
        function validateExpression(expression) {
            var errors = [];

            // æ‹¬å¼§ã®ãƒãƒ©ãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯
            var brackets = { '(': 0, '[': 0, '{': 0 };
            for (var i = 0; i < expression.length; i++) {
                var char = expression[i];
                if (char === '(') brackets['(']++;
                else if (char === ')') brackets['(']--;
                else if (char === '[') brackets['[']++;
                else if (char === ']') brackets['[']--;
                else if (char === '{') brackets['{']++;
                else if (char === '}') brackets['{']--;
            }

            if (brackets['('] !== 0) errors.push('æ‹¬å¼§ () ã®æ•°ãŒåˆã„ã¾ã›ã‚“');
            if (brackets['['] !== 0) errors.push('æ‹¬å¼§ [] ã®æ•°ãŒåˆã„ã¾ã›ã‚“');
            if (brackets['{'] !== 0) errors.push('æ‹¬å¼§ {} ã®æ•°ãŒåˆã„ã¾ã›ã‚“');

            // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
            var existingError = document.getElementById('expressionError');
            if (existingError) existingError.remove();

            if (errors.length > 0) {
                var errorDiv = document.createElement('div');
                errorDiv.id = 'expressionError';
                errorDiv.style.cssText = 'color: #ff6b6b; font-size: 11px; margin-top: 5px; padding: 5px; background: #2a1f1f; border-radius: 3px;';
                errorDiv.textContent = 'âš ï¸ ' + errors.join(', ');
                textarea.parentNode.appendChild(errorDiv);
            }
        }

        // ãƒ‡ãƒãƒƒã‚°ç”¨: Monaco Editorã®çŠ¶æ…‹ã‚’ç¢ºèª
        function debugMonacoState() {
            console.log('=== Monaco Editor Debug Info ===');
            console.log('monacoEditor instance:', monacoEditor);
            console.log('monacoEditor available:', !!monacoEditor);

            var container = document.getElementById('monacoContainer');
            if (container) {
                var rect = container.getBoundingClientRect();
                console.log('Container info:', {
                    exists: !!container,
                    visible: container.offsetParent !== null,
                    dimensions: `${container.offsetWidth}x${container.offsetHeight}`,
                    position: `${rect.left}, ${rect.top}`,
                    display: getComputedStyle(container).display,
                    visibility: getComputedStyle(container).visibility,
                    zIndex: getComputedStyle(container).zIndex
                });
            }

            var textarea = document.getElementById('expressionEditor');
            if (textarea) {
                console.log('Textarea info:', {
                    display: getComputedStyle(textarea).display,
                    visible: textarea.offsetParent !== null
                });
            }
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function () {
            // CSInterfaceåˆæœŸåŒ–ï¼ˆå„ªå…ˆï¼‰
            if (typeof CSInterface !== 'undefined') {
                csInterface = new CSInterface();

                // ExtendScriptãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰
                var extensionRoot = csInterface.getSystemPath(SystemPath.EXTENSION);
                var jsxFile = extensionRoot + '/jsx/expressionControlAPI.jsx';

                console.log('Loading ExtendScript from:', jsxFile);
                csInterface.evalScript('$.evalFile("' + jsxFile + '")', function (result) {
                    console.log('ExtendScript load result:', result);
                    if (result && result !== 'undefined' && result !== '') {
                        console.error('ExtendScript loading error:', result);
                        document.getElementById('statusText').textContent = 'Expression Control - ExtendScript ã‚¨ãƒ©ãƒ¼';
                    } else {
                        console.log('ExtendScript loaded successfully');
                        document.getElementById('statusText').textContent = 'Expression Control - æº–å‚™å®Œäº†';
                    }

                    // é–¢æ•°ãŒæ­£ã—ãèª­ã¿è¾¼ã¾ã‚ŒãŸã‹ãƒ†ã‚¹ãƒˆ
                    csInterface.evalScript('typeof getSelectedLayers', function (typeResult) {
                        console.log('getSelectedLayers type:', typeResult);
                    });

                    // ExtendScriptèª­ã¿è¾¼ã¿å¾Œã«ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã‚’åˆæœŸåŒ–
                    setTimeout(() => {
                        initializeEnhancedEditor();
                    }, 100);
                });
            } else {
                // CSInterfaceãŒåˆ©ç”¨ã§ããªã„å ´åˆï¼ˆé–‹ç™ºæ™‚ãªã©ï¼‰
                console.warn('CSInterface not available - running in mock mode');
                document.getElementById('statusText').textContent = 'Expression Control - Mock Mode';

                // Mock modeã§ã‚‚ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã‚’åˆæœŸåŒ–
                setTimeout(() => {
                    initializeEnhancedEditor();
                }, 100);
            }
        });

        // This Layer(s) ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
        function refreshLayers() {
            console.log('refreshLayers called');
            document.getElementById('layerInfo').textContent = 'ğŸ”„ ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ã‚’æ›´æ–°ä¸­...';

            // This Layer(s)ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã¨ãã‚¨ã‚¯ã‚¹ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã‚’ã‚¯ãƒªã‚¢
            setMonacoValue('');
            currentProperty = null;

            if (!csInterface) {
                console.log('CSInterface not available - using mock mode');
                // Mock mode
                showMessage('Mock Mode: ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
                document.getElementById('layerInfo').textContent = 'âœ… Mock: é¸æŠã•ã‚ŒãŸãƒ¬ã‚¤ãƒ¤ãƒ¼';
                return;
            }

            console.log('CSInterface available, calling ExtendScript...');

            // ã¾ãšExtendScriptãŒåˆ©ç”¨å¯èƒ½ã‹ãƒ†ã‚¹ãƒˆ
            csInterface.evalScript('app.project.activeItem ? "OK" : "NO_COMP"', function (testResult) {
                console.log('ExtendScript test result:', testResult);

                if (testResult === 'NO_COMP') {
                    showMessage('ã‚³ãƒ³ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã—ã¦ãã ã•ã„', 'error');
                    document.getElementById('layerInfo').textContent = 'âŒ ã‚¨ãƒ©ãƒ¼: ã‚³ãƒ³ãƒã‚¸ã‚·ãƒ§ãƒ³ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã§ã¯ã‚ã‚Šã¾ã›ã‚“';
                    return;
                }

                // ExtendScripté–¢æ•°ãŒåˆ©ç”¨å¯èƒ½ã‹ãƒ†ã‚¹ãƒˆ
                csInterface.evalScript('typeof getSelectedLayers !== "undefined" ? "API_OK" : "API_NOT_LOADED"', function (apiResult) {
                    console.log('API test result:', apiResult);

                    if (apiResult === 'API_NOT_LOADED') {
                        showMessage('ExtendScripté–¢æ•°ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                        document.getElementById('layerInfo').textContent = 'âŒ ã‚¨ãƒ©ãƒ¼: é–¢æ•°ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“';
                        return;
                    }

                    // å®Ÿéš›ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±å–å¾—ï¼ˆã‚·ãƒ³ãƒ—ãƒ«å½¢å¼ï¼‰
                    csInterface.evalScript('getSelectedLayers()', function (result) {
                        console.log('getSelectedLayers result:', result);

                        if (result.indexOf('ERROR:') === 0) {
                            var errorMsg = result.substring(6);
                            showMessage(errorMsg, 'error');
                            document.getElementById('layerInfo').textContent = 'âŒ ã‚¨ãƒ©ãƒ¼: ' + errorMsg;
                            return;
                        }

                        if (result.indexOf('SUCCESS:') === 0) {
                            // SUCCESS:2|1:Layer 1|2:Layer 2 å½¢å¼ã‚’è§£æ
                            var parts = result.split('|');
                            var count = parseInt(parts[0].substring(8));

                            selectedLayers = [];
                            for (var i = 1; i < parts.length; i++) {
                                var layerParts = parts[i].split(':');
                                if (layerParts.length >= 2) {
                                    selectedLayers.push({
                                        index: parseInt(layerParts[0]),
                                        name: layerParts.slice(1).join(':') // åå‰ã«ã‚³ãƒ­ãƒ³ãŒå«ã¾ã‚Œã‚‹å ´åˆã«å¯¾å¿œ
                                    });
                                }
                            }

                            updateLayerInfo({ count: count, layers: selectedLayers });
                            loadProperties();
                        } else {
                            console.error('Unexpected result format:', result);
                            showMessage('äºˆæœŸã—ãªã„çµæœå½¢å¼ã§ã™', 'error');
                            document.getElementById('layerInfo').textContent = 'âŒ å½¢å¼ã‚¨ãƒ©ãƒ¼';
                        }
                    });
                });
            });
        }

        function updateLayerInfo(data) {
            var layerInfo = document.getElementById('layerInfo');
            if (data.count === 1) {
                layerInfo.textContent = `âœ… ãƒ¬ã‚¤ãƒ¤ãƒ¼: ${data.layers[0].name}`;
            } else {
                layerInfo.textContent = `âœ… é¸æŠãƒ¬ã‚¤ãƒ¤ãƒ¼: ${data.count}å€‹`;
            }
        }

        function loadProperties() {
            if (selectedLayers.length === 0) {
                return;
            }

            if (selectedLayers.length === 1) {
                // å˜ä¸€ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å ´åˆ
                var layerIndex = selectedLayers[0].index;

                // ã¾ãšãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’å–å¾—
                csInterface.evalScript('debugLayerInfo(' + layerIndex + ')', function (debugResult) {
                    console.log('Layer debug info:', debugResult);

                    // æ¬¡ã«ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’å–å¾—
                    csInterface.evalScript('listVisibleExpressionProps(' + layerIndex + ')', function (result) {
                        handlePropertiesResult(result, false);
                    });
                });
            } else {
                // è¤‡æ•°ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å ´åˆï¼šå…±é€šãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®ã¿å–å¾—
                var layerIndices = selectedLayers.map(function (layer) { return layer.index; });

                console.log('Loading common properties for layers:', layerIndices);

                csInterface.evalScript('listCommonExpressionProps([' + layerIndices.join(',') + '])', function (result) {
                    console.log('Common properties result:', result);
                    handlePropertiesResult(result, true);
                });
            }
        }

        function handlePropertiesResult(result, isCommonProps) {
            console.log('Properties result:', result);

            if (result.indexOf('ERROR:') === 0) {
                var errorMsg = result.substring(6);
                showMessage(errorMsg, 'error');
                return;
            }

            if (result.indexOf('SUCCESS:') === 0) {
                // SUCCESS:5|DEBUG:Transform=7,Contents=2,Text=0,Effects=0|PROP:Transform â†’ Position|EXPR:0 å½¢å¼ã‚’è§£æ
                var parts = result.split('|');
                var successPart = parts[0].substring(8);
                var count = parseInt(successPart);

                // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¡¨ç¤º
                if (parts[1] && parts[1].indexOf('DEBUG:') === 0) {
                    var debugInfo = parts[1].substring(6);
                    console.log('Property scan debug:', debugInfo);
                    if (isCommonProps) {
                        document.getElementById('statusText').textContent = `å…±é€šãƒ—ãƒ­ãƒ‘ãƒ†ã‚£: ${debugInfo}`;
                    } else {
                        document.getElementById('statusText').textContent = `ãƒ‡ãƒãƒƒã‚°: ${debugInfo}`;
                    }
                }

                allProperties = [];
                var existingExpressions = [];

                // æ–°ã—ã„å®‰å…¨ãªè§£æå½¢å¼: |PROP:ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£å|EXPR:0 ã‚’å‡¦ç†
                var startIndex = parts[1] && parts[1].indexOf('DEBUG:') === 0 ? 2 : 1;

                for (var i = startIndex; i < parts.length; i += 2) {
                    // PROP: ã¨ EXPR: ã®ãƒšã‚¢ã§å‡¦ç†
                    if (i + 1 < parts.length &&
                        parts[i].indexOf('PROP:') === 0 &&
                        parts[i + 1].indexOf('EXPR:') === 0) {

                        var propName = parts[i].substring(5); // "PROP:" ã‚’é™¤å»
                        var hasExpression = parts[i + 1].substring(5) === '1'; // "EXPR:" ã‚’é™¤å»

                        var prop = {
                            name: propName,
                            hasExpression: hasExpression,
                            layerIndex: selectedLayers.length === 1 ? selectedLayers[0].index : -1, // è¤‡æ•°é¸æŠæ™‚ã¯-1
                            isCommon: isCommonProps
                        };

                        allProperties.push(prop);

                        if (hasExpression) {
                            existingExpressions.push(prop);
                        }
                    }
                }

                console.log('Parsed properties:', allProperties);
                console.log('Parsed existing expressions:', existingExpressions);

                updatePropertyDropdowns(allProperties, existingExpressions);

                if (count === 0) {
                    if (isCommonProps) {
                        showMessage('é¸æŠã—ãŸãƒ¬ã‚¤ãƒ¤ãƒ¼ã«å…±é€šã™ã‚‹ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚', 'error');
                    } else {
                        showMessage('ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'error');
                    }
                } else {
                    if (isCommonProps) {
                        showMessage(`${count}å€‹ã®å…±é€šãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ (${selectedLayers.length}ãƒ¬ã‚¤ãƒ¤ãƒ¼)`, 'success');
                    } else {
                        showMessage(`${count}å€‹ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ (å®Ÿéš›: ${allProperties.length}å€‹)`, 'success');
                    }
                }
            }
        }

        function updatePropertyDropdowns(allProps, existingExprs) {
            // å…¨ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³
            var allPropsList = document.getElementById('allPropsList');
            allPropsList.innerHTML = '';

            for (var i = 0; i < allProps.length; i++) {
                var item = document.createElement('div');
                item.className = 'dropdown-item';
                item.textContent = allProps[i].name;
                item.onclick = (function (index) {
                    return function () {
                        selectCustomProperty('allProps', index);
                    };
                })(i);
                allPropsList.appendChild(item);
            }

            // æ—¢å­˜ã‚¨ã‚¯ã‚¹ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³
            var existingExprsList = document.getElementById('existingExprsList');
            existingExprsList.innerHTML = '';

            // æ—¢å­˜ã‚¨ã‚¯ã‚¹ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ã‚’æ ¼ç´
            window.existingExpressions = existingExprs;

            for (var j = 0; j < existingExprs.length; j++) {
                var item = document.createElement('div');
                item.className = 'dropdown-item';
                item.textContent = existingExprs[j].name;
                item.onclick = (function (index) {
                    return function () {
                        selectCustomProperty('existingExprs', index);
                    };
                })(j);
                existingExprsList.appendChild(item);
            }

            // é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('allPropsSelected').textContent = 'ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’é¸æŠ...';
            document.getElementById('existingExprsSelected').textContent = '-----';
        }

        // ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®åˆ¶å¾¡é–¢æ•°
        function toggleDropdown(dropdownType) {
            var listId = dropdownType === 'allProps' ? 'allPropsList' : 'existingExprsList';
            var buttonId = dropdownType === 'allProps' ? 'allPropsCustomDropdown' : 'existingExprsCustomDropdown';

            var list = document.getElementById(listId);
            var button = document.querySelector('#' + buttonId + ' .dropdown-button');
            var section = document.getElementById(buttonId).closest('.section');

            // ä»–ã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’é–‰ã˜ã‚‹
            closeAllDropdowns();

            // ã“ã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’é–‹ã/é–‰ã˜ã‚‹
            if (list.classList.contains('show')) {
                list.classList.remove('show');
                button.classList.remove('open');
                section.classList.remove('dropdown-open');
            } else {
                list.classList.add('show');
                button.classList.add('open');
                section.classList.add('dropdown-open');
            }
        }

        function closeAllDropdowns() {
            var dropdowns = document.querySelectorAll('.dropdown-list');
            var buttons = document.querySelectorAll('.dropdown-button');
            var sections = document.querySelectorAll('.section');

            dropdowns.forEach(function (dropdown) {
                dropdown.classList.remove('show');
            });

            buttons.forEach(function (button) {
                button.classList.remove('open');
            });

            sections.forEach(function (section) {
                section.classList.remove('dropdown-open');
            });
        }

        function selectCustomProperty(dropdownType, index) {
            if (dropdownType === 'allProps') {
                if (allProperties[index]) {
                    var selectedProp = allProperties[index];
                    currentProperty = selectedProp;
                    document.getElementById('allPropsSelected').textContent = selectedProp.name;
                    document.getElementById('statusText').textContent = `ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£é¸æŠ: ${selectedProp.name}`;

                    // åŒã˜åå‰ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒè¨˜å…¥æ¸ˆã¿ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                    var matchingExistingIndex = -1;
                    if (window.existingExpressions) {
                        for (var i = 0; i < window.existingExpressions.length; i++) {
                            if (window.existingExpressions[i].name === selectedProp.name) {
                                matchingExistingIndex = i;
                                break;
                            }
                        }
                    }

                    if (matchingExistingIndex >= 0) {
                        // è¨˜å…¥æ¸ˆã¿ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ã‚‚åŒã˜ã‚‚ã®ãŒã‚ã‚‹å ´åˆã¯åŒæœŸ
                        var existingProp = window.existingExpressions[matchingExistingIndex];
                        document.getElementById('existingExprsSelected').textContent = existingProp.name;

                        // æ—¢å­˜ã‚¨ã‚¯ã‚¹ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ã®å†…å®¹ã‚’å–å¾—
                        csInterface.evalScript('getExpressionContent(' + existingProp.layerIndex + ', "' + existingProp.name + '")', function (result) {
                            console.log('Expression content result:', result);
                            if (result.indexOf('SUCCESS:') === 0) {
                                var expression = result.substring(8);
                                setMonacoValue(expression);
                                showMessage('æ—¢å­˜ã‚¨ã‚¯ã‚¹ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ', 'success');
                            }
                        });
                    } else {
                        // è¨˜å…¥æ¸ˆã¿ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ãªã„å ´åˆã¯-----ã«ãƒªã‚»ãƒƒãƒˆ
                        document.getElementById('existingExprsSelected').textContent = '-----';
                        // ã‚¨ã‚¯ã‚¹ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã‚‚ã‚¯ãƒªã‚¢
                        setMonacoValue('');
                        showMessage(`${selectedProp.name} ã‚’é¸æŠã—ã¾ã—ãŸ`, 'success');
                    }
                }
            } else if (dropdownType === 'existingExprs') {
                if (window.existingExpressions && window.existingExpressions[index]) {
                    var existingProp = window.existingExpressions[index];
                    currentProperty = existingProp;
                    document.getElementById('existingExprsSelected').textContent = existingProp.name;

                    // åŒã˜åå‰ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒå¯èƒ½ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                    var matchingAllPropsIndex = -1;
                    if (allProperties) {
                        for (var j = 0; j < allProperties.length; j++) {
                            if (allProperties[j].name === existingProp.name) {
                                matchingAllPropsIndex = j;
                                break;
                            }
                        }
                    }

                    if (matchingAllPropsIndex >= 0) {
                        // å¯èƒ½ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ã‚‚åŒã˜ã‚‚ã®ãŒã‚ã‚‹å ´åˆã¯åŒæœŸ
                        document.getElementById('allPropsSelected').textContent = existingProp.name;
                    }

                    // æ—¢å­˜ã‚¨ã‚¯ã‚¹ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ã®å†…å®¹ã‚’å–å¾—
                    csInterface.evalScript('getExpressionContent(' + existingProp.layerIndex + ', "' + existingProp.name + '")', function (result) {
                        console.log('Expression content result:', result);

                        if (result.indexOf('SUCCESS:') === 0) {
                            var expression = result.substring(8);
                            setMonacoValue(expression);
                            showMessage('æ—¢å­˜ã‚¨ã‚¯ã‚¹ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ', 'success');
                        } else if (result.indexOf('ERROR:') === 0) {
                            showMessage('ã‚¨ã‚¯ã‚¹ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + result.substring(6), 'error');
                        }
                    });

                    document.getElementById('statusText').textContent = `æ—¢å­˜ã‚¨ã‚¯ã‚¹ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³: ${existingProp.name}`;
                }
            }

            closeAllDropdowns();
        }

        // å¤–éƒ¨ã‚¯ãƒªãƒƒã‚¯ã§ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’é–‰ã˜ã‚‹
        document.addEventListener('click', function (event) {
            if (!event.target.closest('.custom-dropdown')) {
                closeAllDropdowns();
            }
        });

        function selectProperty() {
            var dropdown = document.getElementById('allPropsDropdown');
            var selectedIndex = dropdown.value;

            if (selectedIndex !== '' && allProperties[selectedIndex]) {
                currentProperty = allProperties[selectedIndex];
                document.getElementById('statusText').textContent = `ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£é¸æŠ: ${currentProperty.name}`;
                showMessage(`${currentProperty.name} ã‚’é¸æŠã—ã¾ã—ãŸ`, 'success');
            }
        }

        function selectExistingExpression() {
            var dropdown = document.getElementById('existingExprsDropdown');
            var selectedIndex = dropdown.value;

            if (selectedIndex !== '' && window.existingExpressions && window.existingExpressions[selectedIndex]) {
                var prop = window.existingExpressions[selectedIndex];
                currentProperty = prop;

                // ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚‚åŒæœŸ
                var allDropdown = document.getElementById('allPropsDropdown');
                for (var i = 0; i < allProperties.length; i++) {
                    if (allProperties[i].name === prop.name) {
                        allDropdown.value = i;
                        break;
                    }
                }

                // æ—¢å­˜ã‚¨ã‚¯ã‚¹ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ã®å†…å®¹ã‚’å–å¾—
                csInterface.evalScript('getExpressionContent(' + prop.layerIndex + ', "' + prop.name + '")', function (result) {
                    console.log('Expression content result:', result);

                    if (result.indexOf('SUCCESS:') === 0) {
                        var expression = result.substring(8);
                        setMonacoValue(expression);
                        showMessage('æ—¢å­˜ã‚¨ã‚¯ã‚¹ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ', 'success');
                    } else if (result.indexOf('ERROR:') === 0) {
                        showMessage('ã‚¨ã‚¯ã‚¹ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + result.substring(6), 'error');
                    }
                });

                document.getElementById('statusText').textContent = `æ—¢å­˜ã‚¨ã‚¯ã‚¹ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³: ${prop.name}`;
            }
        }

        function applyExpression() {
            var expression = getMonacoValue();

            if (!expression || expression.trim() === '') {
                showMessage('ã‚¨ã‚¯ã‚¹ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ãŒç©ºã§ã™', 'error');
                return;
            }

            if (!currentProperty) {
                showMessage('ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }

            if (selectedLayers.length === 0) {
                showMessage('ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }

            if (!csInterface) {
                showMessage('ğŸš€ Mock: ã‚¨ã‚¯ã‚¹ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ã‚’é©ç”¨ã—ã¾ã—ãŸï¼', 'success');
                return;
            }

            showMessage('ğŸš€ ã‚¨ã‚¯ã‚¹ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ã‚’é©ç”¨ä¸­...', 'success');

            // é¸æŠã•ã‚ŒãŸå…¨ã¦ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«é©ç”¨
            var applyCount = 0;
            var errorCount = 0;

            function applyToNextLayer(index) {
                if (index >= selectedLayers.length) {
                    // å…¨ã¦å®Œäº†
                    if (errorCount === 0) {
                        showMessage(`âœ… ${applyCount}å€‹ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ã‚¨ã‚¯ã‚¹ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ã‚’é©ç”¨ã—ã¾ã—ãŸ`, 'success');
                    } else {
                        showMessage(`âš ï¸ ${applyCount}å€‹æˆåŠŸã€${errorCount}å€‹ã‚¨ãƒ©ãƒ¼`, 'error');
                    }

                    // ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãƒªã‚¹ãƒˆã‚’æ›´æ–°ã—ã¦æ–°ã—ã„ã‚¨ã‚¯ã‚¹ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ã‚’åæ˜ 
                    loadProperties();
                    return;
                }

                var layer = selectedLayers[index];
                var scriptCall = 'applyExpressionToProperty(' + layer.index + ', "' + currentProperty.name + '", ' + JSON.stringify(expression) + ')';

                csInterface.evalScript(scriptCall, function (result) {
                    console.log('Apply result for layer', layer.index, ':', result);

                    if (result.indexOf('SUCCESS:') === 0) {
                        applyCount++;
                    } else {
                        errorCount++;
                        console.error('Apply error:', result);
                    }

                    // æ¬¡ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¸
                    applyToNextLayer(index + 1);
                });
            }

            // è¤‡æ•°ãƒ¬ã‚¤ãƒ¤ãƒ¼é¸æŠæ™‚ã®ãƒ­ã‚°
            if (selectedLayers.length > 1) {
                console.log('Applying expression to', selectedLayers.length, 'layers for common property:', currentProperty.name);
            }

            // æœ€åˆã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‹ã‚‰é–‹å§‹
            applyToNextLayer(0);
        }

        function showMessage(message, type) {
            var successMsg = document.getElementById('successMessage');
            var errorMsg = document.getElementById('errorMessage');

            // æ—¢å­˜ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éš ã™
            successMsg.style.display = 'none';
            errorMsg.style.display = 'none';

            if (type === 'success') {
                successMsg.textContent = message;
                successMsg.style.display = 'block';

                // 3ç§’å¾Œã«è‡ªå‹•çš„ã«éš ã™
                setTimeout(function () {
                    successMsg.style.display = 'none';
                }, 3000);
            } else if (type === 'error') {
                errorMsg.textContent = message;
                errorMsg.style.display = 'block';

                // 5ç§’å¾Œã«è‡ªå‹•çš„ã«éš ã™
                setTimeout(function () {
                    errorMsg.style.display = 'none';
                }, 5000);
            }
        }
    </script>
</body>

</html>